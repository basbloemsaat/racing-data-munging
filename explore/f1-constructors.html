<!DOCTYPE html>
<html>

<head>
    <title>f1 constructors</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <style>
    div#edges {
        position: absolute;
        left: 0px;
        right: 0px;
        top: 0px;
        bottom: 0px;
        z-index: 0;
        visibility: hidden;
    }
    </style>
</head>

<body>
    <h1 id="pagetitle">F1 constructors</h1>
    <div id="edges"></div>
    <table id="list_constructors" class="table">
        <thead>
            <tr>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="js/rdm.js"></script>
    <script>
    (function() {

        this.columns = [{
                title: "Constructor",
                f_val: function(d) { return d.name; },
                f_href: function(d) {return d.url; },
                sort_default: 'asc',
            },
            {
                title: "Nationality",
                f_val: function(d) { return d.nationality; },
                sort_default: 'asc',
            },
            {
                title: "Races",
                f_val: function(d) {
                    var res = d.years_active.length ? d.years_active.reduce(rdm.reduce_sum('races')) : { "races": 0 };
                    return res.races;
                },
                sort_default: 'desc',
            },
            {
                title: "Wins",
                f_val: function(d) {
                    var res = d.years_active.length ? d.years_active.reduce(rdm.reduce_sum('wins')) : { "wins": 0 };
                    return res.wins;
                },
                sort_default: 'desc',
            },
            {
                title: "Podiums",
                f_val: function(d) {
                    var res = d.years_active.length ? d.years_active.reduce(rdm.reduce_sum('podiums')) : { "podiums": 0 };
                    return res.podiums;
                },
                sort_default: 'desc',
            },
            {
                title: "First Entry",
                f_val: function(d) {
                    var res = d.years_active.length ? d.years_active.reduce(rdm.reduce_min('year')) : { "year": 0 };
                    return res.year;
                },
                sort_default: 'asc',
            },
            {
                title: "Last Entry",
                f_val: function(d) {
                    var res = d.years_active.length ? d.years_active.reduce(rdm.reduce_max('year')) : { "year": 0 };
                    return res.year;
                },
                sort_default: 'desc',
            },
        ]

        this.loaded_data = {};
        this.current_sort = {
            title: "none",
            order: "unsorted",
        }

        this.initCharts = function() {
            d3.select('table#list_constructors thead').selectAll('th')
                .data(rdm.columns)
                .enter()
                .append('th')
                .on('click', function(d) {
                    var sort_order = d.sort_default;
                    if (
                        rdm.current_sort.title ==  d.title
                        && rdm.current_sort.order == sort_order
                    ) {
                        sort_order = (sort_order == 'asc' ? 'desc' : 'asc');
                    }

                    rdm.sortby(d.f_val, sort_order);
                    rdm.current_sort.title = d.title;
                    rdm.current_sort.order = sort_order;
                })
                .text(function(d) { return d.title });

            rdm.loadData();
        }

        this.loadData = function() {
            var uri = "/racing-data-munging/data/ergast/constructors.json"
            d3.json(uri)
                .then(
                    function(data) {
                        rdm.loaded_data['constructors_list'] = data;
                        rdm.update_constructors_overview(rdm.loaded_data['constructors_list'])
                    }
                );
        }

        this.sortby = function(sort_term, sort_direction) {

            data = rdm.loaded_data['constructors_list'];
            data.sort(function(a, b) {
                key_a = sort_term(a);
                key_b = sort_term(b);
                if (key_a > key_b) return (sort_direction == 'asc' ? 1 : -1);
                if (key_a < key_b) return (sort_direction == 'asc' ? -1 : 1);
                return 0;
            })
            rdm.update_constructors_overview(data);
        }

        this.update_constructors_overview = function(data) {
            var tbody = d3.select('table#list_constructors tbody');
            tbody.selectAll("tr").remove();

            var rows = tbody.selectAll('tr').data(data);

            addrows = rows.enter().append('tr');

            for (var i = 0; i < rdm.columns.length; i++) {
                tds = addrows.append("td").attr("class", "name")
                if (typeof rdm.columns[i]['f_href'] == 'function') {
                    tds = tds.append('a')
                        .attr('href', rdm.columns[i]['f_href'])
                    
                }
                tds.text(rdm.columns[i].f_val);
            }
        }
    }).apply(rdm);

    rdm.initCharts();
    </script>
</body>

</html>