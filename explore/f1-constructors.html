<!DOCTYPE html>
<html>

<head>
    <title>f1 constructors</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <style>
    div#all_seasons_edges {
        position: absolute;
        left: 0px;
        right: 0px;
        top: 0px;
        bottom: 0px;
        z-index: 0;
        display: hidden;
    }

    svg#all_seasons {
        border: 0px solid red;
        z-index: 1;
    }

    rect.bar {
        fill: CornflowerBlue;
    }

    rect.bar:hover {
        fill: orange;
    }
    </style>
</head>

<body>
    <h1 id="pagetitle">F1 constructors</h1>
    <div id="edges"></div>
    <table id="list_constructors" class="table">
        <thead>
            <tr>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="js/rdm.js"></script>
    <script>
    (function() {

        var sum = function(variable) {
            return function(a, b) {
                var x = {};
                x[variable] = a[variable] + b[variable];
                return x
            };
        }

        this.columns = [{
                "title": "Constructor",
                "df": function(d) { return d.name; },
            },
            {
                "title": "Nationality",
                "df": function(d) { return d.nationality; },
            },
            {
                "title": "Races",
                "df": function(d) { 
                    var res = d.years_active.length ? d.years_active.reduce(sum('races')) : {"races": 0};
                    return res.races;
                },
            },
            {
                "title": "Wins",
                "df": function(d) { return d.name; },
            },
            {
                "title": "Podiums",
                "df": function(d) { return d.name; },
            },
            {
                "title": "First Entry",
                "df": function(d) { return d.name; },
            },
            {
                "title": "Last Entry",
                "df": function(d) { return d.name; },
            },
        ]

        this.reduce_functions = {
            // "races": function(a, b) { return { "races": a.races + b.races } },
            // "wins": function(a, b) { return { "wins": a.wins + b.wins } },
        }

        this.loaded_data = {};

        var variables = ['races', 'wins', 'podiums'];
        for (var i = 0; i < variables.length; i++) {
            var variable = variables[i];
            var sum = function(variable) {
                return function(a, b) {
                    var x = {};
                    x[variable] = a[variable] + b[variable];
                    return x
                };
            }
            this.reduce_functions[variable] = sum(variable);
        }

        this.initCharts = function() {
            d3.select('table#list_constructors thead').selectAll('th')
                .data(rdm.columns)
                .enter()
                .append('th')
                .text(function(d) { return d.title })

            ;

            rdm.loadData();
        }

        this.loadData = function() {
            var uri = "/racing-data-munging/data/ergast/constructors.json"
            d3.json(uri)
                .then(
                    function(data) {
                        rdm.loaded_data['constructors_list'] = data;
                        rdm.update_constructors_overview(rdm.loaded_data['constructors_list'])
                    }
                );
        }

        this.sortby = function(sort_term) {

            update_constructors_overview();
        }

        this.update_constructors_overview = function(data) {
            console.log(data)
            var tbody = d3.select('table#list_constructors tbody');
            tbody.selectAll("tr").remove();

            var rows = tbody.selectAll('tr').data(data);

            addrows = rows.enter().append('tr');

            for (var i = 0; i < rdm.columns.length; i++) {
                addrows.append("td").attr("class", "name").text(rdm.columns[i].df);
            }


            addrows.append("td").attr("class", "nat").text(function(d) { return d.nationality; });

            addrows.append("td").attr("class", "races").text(function(d) {
                var res = d.years_active.length ? d.years_active.reduce(rdm.reduce_functions.races) : 0;
                return res.races;
            });

            addrows.append("td").attr("class", "wins").text(function(d) {
                var res = d.years_active.length ? d.years_active.reduce(rdm.reduce_functions.wins) : 0;
                return res.wins;
            });

            addrows.append("td").attr("class", "podiums").text(function(d) {
                var res = d.years_active.length ? d.years_active.reduce(rdm.reduce_functions.podiums) : 0;
                return res.podiums;
            });

            var red_firstyear = function(a, b) {
                return { "year": (a.year < b.year ? a.year : b.year) }
            }
            addrows.append("td").attr("class", "firstyear").text(function(d) {
                var res = d.years_active.length ? d.years_active.reduce(red_firstyear) : 0;
                return res.year;
            });

            var red_lastyear = function(a, b) {
                return { "year": (a.year > b.year ? a.year : b.year) }
            }
            addrows.append("td").attr("class", "lastyear").text(function(d) {
                var res = d.years_active.length ? d.years_active.reduce(red_lastyear) : 0;
                return res.year;
            });


        }
    }).apply(rdm);

    rdm.initCharts();
    </script>
</body>

</html>